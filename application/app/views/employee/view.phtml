<!DOCTYPE html>
<html>
<head>
    <title>View Employee</title>
</head>
<body>
<div class="container">
    <h1>Edit Employee</h1>

    <form id="edit-user-form">
        <div class="form-group">
            <label for="first_name">First Name:</label>
            <input type="text" class="form-control" id="first_name" required>
        </div>
        <div class="form-group">
            <label for="last_name">Last Name:</label>
            <input type="text" class="form-control" id="last_name" required>
        </div>
        <div class="form-group">
            <label for="contact_number">Contact Number:</label>
            <input type="text" class="form-control" id="contact_number" required>
        </div>
        <div class="form-group">
            <label for="date_of_birth">Date of Birth:</label>
            <input type="date" class="form-control" id="date_of_birth" required>
        </div>
        <div class="form-group">
            <label for="street_address">Street Address:</label>
            <input type="text" class="form-control" id="street_address" required>
        </div>
        <div class="form-group">
            <label for="city">City:</label>
            <input type="text" class="form-control" id="city" required>
        </div>
        <div class="form-group">
            <label for="country">Country:</label>
            <input type="text" class="form-control" id="country" required>
        </div>
        <div class="form-group">
            <label for="postal_code">Postal Code:</label>
            <input type="text" class="form-control" id="postal_code" required>
        </div>

        <div id="skill-area">
            <h3>Skills</h3>
        </div>

        <button type="button" class="btn btn-primary" id="add-skill">Add Skill</button>
        <button type="submit" class="btn btn-success">Update Employee</button>
    </form>

</div>

<script>
    var employeeId = window.location.pathname.split('/').pop();
    var seniorityRatings = [];

    function fetchSeniorityRatings() {
        $.ajax({
            type: 'GET',
            url: 'http://localhost:8080/ratings/all',
            success: function(response) {
                seniorityRatings = response;
            },
            error: function(error) {
                console.error(error);
                alert('Error fetching seniority ratings');
            }
        });
    }

    function addSkillGroup(skill) {
        var seniorityOptionsHtml = seniorityRatings.map(function(rating) {
            return '<option value="' + rating.id + '"' + (skill && skill.seniority_rating_id === rating.id ? ' selected' : '') + '>' + rating.rating + '</option>';
        }).join('');

        var skillGroup = $(
            '<div class="skill-group row">'+
            '<div class="form-group col-md-4">'+
            '<label for="skill_name">Skill Name:</label>'+
            '<input type="text" class="form-control skill_name" value="' + (skill ? skill.skill_name : '') + '" required>'+
            '</div>'+
            '<div class="form-group col-md-4">'+
            '<label for="years_experience">Years Experience:</label>'+
            '<input type="number" class="form-control years_experience" value="' + (skill ? skill.years_experience : '') + '" required>'+
            '</div>'+
            '<div class="form-group col-md-4">'+
            '<label for="seniority_rating_id">Seniority Rating:</label>'+
            '<select class="form-control seniority_rating_id" required>'+
            seniorityOptionsHtml+
            '</select>'+
            '</div>'+
            '<button type="button" class="btn btn-danger remove-skill">Remove Skill</button>'+
            '</div>'
        );

        if (skill) {
            skillGroup.data('skill-id', skill.id);
        }

        $('#skill-area').append(skillGroup);
    }


    $(document).ready(function() {
        fetchSeniorityRatings();

        // Get employee data and populate form
        $.ajax({
            type: 'GET',
            url: 'http://localhost:8080/employee/id/' + employeeId,
            success: function(response) {
                // Fill in form fields with response data
                $('#first_name').val(response.first_name);
                $('#last_name').val(response.last_name);
                $('#contact_number').val(response.contact_number);
                $('#date_of_birth').val(new Date(response.date_of_birth).toISOString().substring(0, 10));
                $('#street_address').val(response.street_address);
                $('#city').val(response.city);
                $('#country').val(response.country);
                $('#postal_code').val(response.postal_code);

                // For skills, create a skill group for each skill
                response.skills.forEach(function(skill) {
                    addSkillGroup(skill);
                });
            },
            error: function(error) {
                console.error(error);
                alert('Error fetching employee data');
            }
        });

        $('#add-skill').click(function() {
            addSkillGroup();
        });

        $(document).on('click', '.remove-skill', function() {
            $(this).parent('.skill-group').remove();
        });

        $('#edit-user-form').submit(function(e) {
            e.preventDefault();

            // Prepare data
            var data = {
                first_name: $('#first_name').val(),
                last_name: $('#last_name').val(),
                contact_number: $('#contact_number').val(),
                date_of_birth: $('#date_of_birth').val(),
                street_address: $('#street_address').val(),
                city: $('#city').val(),
                country: $('#country').val(),
                postal_code: $('#postal_code').val(),
                skills: []
            };

            $('.skill-group').each(function() {
                var skill = {
                    skill_name: $(this).find('.skill_name').val(),
                    years_experience: $(this).find('.years_experience').val(),
                    seniority_rating_id: $(this).find('.seniority_rating_id').val()
                };

                var skillId = $(this).data('skill-id');
                if (skillId) {
                    skill.id = skillId;
                }

                data.skills.push(skill);
            });

            // PUT request
            $.ajax({
                type: 'PUT',
                url: 'http://localhost:8080/employee/update/' + employeeId,
                data: JSON.stringify(data),
                contentType: 'application/json',
                success: function(response) {
                    Swal.fire({
                        title: 'Success!',
                        text: 'Employee updated successfully',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = '/';
                        }
                    });
                },
                error: function(error) {
                    console.error(error);
                    alert('Error updating data');
                    Swal.fire({
                        title: 'Error!',
                        text: 'Failed to update employee data',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            });
        });


    });
</script>
</body>
</html>
